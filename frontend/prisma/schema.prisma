// ─────────────────────────────────────────────────────────
//  Lucid AI — Multi-Tenant SaaS Prisma Schema
//  Stack: Next.js 14 · PostgreSQL · NextAuth v5
// ─────────────────────────────────────────────────────────

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-1.1.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════
//  ENUMS
// ═══════════════════════════════════════════════════════════

enum GitProvider {
  GITHUB
  GITLAB
}

enum Role {
  OWNER
  ADMIN
  MEMBER
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  FAILED
}

// ═══════════════════════════════════════════════════════════
//  ORGANIZATION — Multi-Tenancy Root
// ═══════════════════════════════════════════════════════════

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  plan      String   @default("free") // free | pro | enterprise
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members      Membership[]
  projects     Project[]
  integrations Integration[]

  @@map("organizations")
}

// ═══════════════════════════════════════════════════════════
//  USER — Supports OAuth (Google, GitHub, etc.)
// ═══════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Default/Active organization for simple multi-tenancy
  orgId         String?

  // NextAuth relations
  accounts Account[]

  // Multi-tenancy: user can belong to multiple orgs
  memberships   Membership[]
  agentSessions AgentSession[]
  integrations  Integration[]

  @@map("users")
}

// ═══════════════════════════════════════════════════════════
//  MEMBERSHIP — Join table: User ↔ Organization
// ═══════════════════════════════════════════════════════════

model Membership {
  id     String @id @default(cuid())
  role   Role   @default(MEMBER)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  orgId  String
  org    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, orgId])
  @@map("memberships")
}

// ═══════════════════════════════════════════════════════════
//  ACCOUNT — NextAuth OAuth Accounts
// ═══════════════════════════════════════════════════════════

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// ═══════════════════════════════════════════════════════════
//  PROJECT — Linked to Organization
// ═══════════════════════════════════════════════════════════

model Project {
  id        String      @id @default(cuid())
  name      String
  repoUrl   String?
  provider  GitProvider?
  branch    String      @default("main")
  isActive  Boolean     @default(true)

  orgId     String
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Which encrypted token to use when cloning this repo
  integrationId String?
  integration   Integration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agentSessions AgentSession[]

  @@map("projects")
}

// ═══════════════════════════════════════════════════════════
//  INTEGRATION — Encrypted Git Provider Tokens (User-owned)
// ═══════════════════════════════════════════════════════════

model Integration {
  id       String      @id @default(cuid())
  provider GitProvider
  label    String?     // e.g. "Work GitHub", "Personal GitLab"

  // Encrypted access token (AES-256-CTR)
  encryptedToken String @db.Text
  iv             String // Initialization vector (hex)

  // Optional metadata
  externalUsername String?
  scopes           String?  // comma-separated scopes
  expiresAt        DateTime?

  // User-level ownership — who connected this token
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Org-level visibility — which org this integration belongs to
  orgId String
  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  // Projects using this integration
  projects Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, provider, label]) // one integration per provider+label per user
  @@index([orgId])
  @@index([userId])
  @@map("integrations")
}

// ═══════════════════════════════════════════════════════════
//  AGENT SESSION — Active AI Agent Sessions
// ═══════════════════════════════════════════════════════════

model AgentSession {
  id        String        @id @default(cuid())
  title     String?
  status    SessionStatus @default(ACTIVE)

  // External session identifier from the AI agent runtime
  agentSessionId String?  @unique

  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  metadata  Json?    // flexible metadata (model used, tokens, etc.)

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([status])
  @@map("agent_sessions")
}
